' ********** Copyright 2016 Roku Corp.  All Rights Reserved. ********** 

sub init()
    m.feedList = m.top.findNode("feedList")
    m.loadingIndicator = m.top.findNode("loadingIndicator")
    m.loadingIndicator.opacity = 1.0
    fetch()
end sub

sub fetch()
    m.downloadFeedTask = CreateObject("roSGNode", "FeedDownloader")
    m.downloadFeedTask.observeField("content", "setContent")
    m.downloadFeedTask.control = "RUN"
    m.top.setFocus(true)
end sub

sub setContent():
    m.feedList.content = m.downloadFeedTask.content
    m.loadingIndicator.opacity = 0.0
end sub

function onKeyEvent(key as String, press as Boolean) as Boolean
    ? "onKeyEvent"
    handled = false

    if (press)
        if (key = "play")
            handled = true
            m.videoPlayer.control = "play"
        end if
        if (key = "pause")
            handled = true
            m.videoPlayer.control = "pause"
        end if
        if (key = "OK")
            handled = true
            video = m.feedList.itemFocused
            openYoutube(video)
        end if
    end if
    return handled
end function

sub openYoutube(video)
    if (m.video.hasField("StreamFormat") andm.video.StreamFormat = "youtube")
        m.YoutubeLinkOpenerTask = CreateObject("roSGNode", "YoutubeLinkOpener")
        m.YoutubeLinkOpenerTask.setField("videoId",video.VideoUrl)
        m.YoutubeLinkOpenerTask.observeField("content", "setContent")
        m.YoutubeLinkOpenerTask.control = "RUN"
    end if
end sub
